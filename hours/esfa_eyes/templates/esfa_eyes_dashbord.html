{% extends "base.html" %}
{% load static %}
{% load connector_template_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sheets/css/jspreadsheet.css' %}">
<link rel="stylesheet" href="{% static 'sheets/css/jspreadsheet.datatables.css' %}">
<link rel="stylesheet" href="{% static 'sheets/css/jspreadsheet.theme.css' %}">
<style>

</style>
{% endblock extra_css %}
{% block body %}

<!-- ======================= body ======================= -->
<div id="container" class="d-flex flex-column h-100 gap-1 gap-md-2 m-2 mx-md-4">
    <div id="top-container" class="d-flex flex-row justify-content-between justify-content-md-start gap-md-5">
        <div class="p-2anann">
            <strong>Year</strong>
            <div class="mt-1">
                <select name="year" id="year" class="form-select">
                </select>
            </div>
        </div>
        <div class="p-2anann">
            <strong>Dollar:</strong>
            <div id="dollar-holder" class="border rounded p-2 text-muted bg-light pe-none">100,000 T</div>
        </div>
        <div class="p-2anann">
            <strong>Yuan:</strong>
            <div id="yuan-holder" class="border rounded p-2 text-muted bg-light pe-none">100,000 T</div>
        </div>
    </div>

    <div id="tables-container" class="flex-grow-1 bg-warning">
        4
    </div>
</div>


<!-- ======================= scripts ======================= -->
<script src="{% static 'sheets/js/esfa_persian_holidays.min.js' %}"></script>
<script src="{% static 'sheets/js/plotly-basic.min.js' %}"></script>
<script src="{% static 'sheets/js/jspreadsheet.min.js' %}"></script>
<script>
    async function updateCurrencies() {
        //result = await getCurrencies();
        result = {
            "USD": {
                "date": "1404/06/06",
                "time": "12:16",
                "time_unix": 1756370760,
                "symbol": "USD",
                "name_en": "US Dollar",
                "name": "دلار",
                "price": 100150,
                "change_value": -300,
                "change_percent": -0.3,
                "unit": "تومان"
            },
            "CNY": {
                "date": "1404/06/06",
                "time": "12:17",
                "time_unix": 1756370820,
                "symbol": "CNY",
                "name_en": "Chinese Yuan",
                "name": "یوآن چین",
                "price": 14170,
                "change_value": 130,
                "change_percent": 0.93,
                "unit": "تومان"
            }
        };

        $('#dollar-holder').text(result.USD.price.toLocaleString() + ' T');
        $('#yuan-holder').text(result.CNY.price.toLocaleString() + ' T');
    }

    async function getCurrencies() {
        return apiService.get('https://BrsApi.ir/Api/Market/Gold_Currency.php?key=BfTErgVQ4YHlDZ33IcmWap9FhgiWU17H', {}, {}, "failed to get currencies")
            .then(result => {
                if (result.success) {
                    return { "USD": result.data.currency[1], "CNY": result.data.currency[9] };
                } else {
                    console.error('Error:', result.error);
                }
            });
    }





    async function initTable() {
        const year = $("#year").val();
        //let sheet = await getEsfaEyesInfo(year);

        //constructTable(sheet.data, sheet.submitted);
        //onChangeHandler();
    }

    async function getEsfaEyesInfo(year) {
        const url = `{% url "esfa_eyes:api_eyes" year='yearHolder' %}`
            .replace("yearHolder", year)
        try {
            let res = await fetch(url);
            return await res.json();
        }
        catch (err) {
            jSuites.notification({
                error: 1,
                name: 'Error',
                title: "Fetching This month's Sheet",
                message: err,
            });
        }
        apiService.get($`eyes/${year}`)
    }

    async function constructTable(data, readOnlyAll = false) {

    }

    function saveSheet(data) {
        const year = $("#year").val();
        const month = $("#month").val();
        const url = `{% url "sheets:api_sheets" year='yearHolder' month='monthHolder' %}`
            .replace("yearHolder", year)
            .replace("monthHolder", month);
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{csrf_token}}',
            },
            body: JSON.stringify({ "data": data, "saveSheet": true }),
        })
            .then(res => res.json())
            .then(() => updatePaymentsValue())
            .catch(err => {
                jSuites.notification({
                    error: 1,
                    name: 'Error',
                    title: "Updating Sheet",
                    message: err,
                });
            });
    }

    function fillYears(year) {
        for (let i = window.START_YEAR; i <= year; i++) {
            $("#year").append($("<option>").text(i));
        }
    }


    // =================== document ready ============================
    $("document").ready(async function () {
        const today = new JDate();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        updateCurrencies();

        fillYears(currentYear);
        $("#year").val(currentYear);

        initTable();
        $("#year, #month").change(function () {
            initTable();
        });
    });

</script>
{% endblock body %}