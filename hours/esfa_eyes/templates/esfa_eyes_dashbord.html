{% extends "base.html" %}
{% load static %}
{% load connector_template_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sheets/css/jspreadsheet.css' %}">
<link rel="stylesheet" href="{% static 'sheets/css/jspreadsheet.datatables.css' %}">
<link rel="stylesheet" href="{% static 'sheets/css/jspreadsheet.theme.css' %}">
<style>

</style>
{% endblock extra_css %}
{% block body %}

<!-- ======================= body ======================= -->
<div id="container" class="d-flex flex-column h-100 gap-1 m-1">
    <div id="top-container" class="d-flex flex-row justify-content-between justify-content-md-start gap-md-3">
        <div class="p-2 bg-primary">
            <strong>Year</strong>
            <div class="mt-1">
                <select name="year" id="year" class="form-select">
                </select>
            </div>
        </div>
        <div class="p-2 bg-primary">
            <strong>Dollar</strong>
        </div>
        <div class="p-2 bg-primary">
            <strong>Yuan</strong>
        </div>
    </div>

    <div id="tables-container" class="flex-grow-1 bg-warning">
        4
    </div>
</div>


<!-- ======================= scripts ======================= -->
<script src="{% static 'sheets/js/esfa_persian_holidays.min.js' %}"></script>
<script src="{% static 'sheets/js/plotly-basic.min.js' %}"></script>
<script src="{% static 'sheets/js/jspreadsheet.min.js' %}"></script>
<script src="{% static 'esfa_eyes/js/dollar-tomans-api.min.js' %}"></script>
<script>

    async function initTable() {
        const year = $("#year").val();
        //let sheet = await getEsfaEyesInfo(year);

        //constructTable(sheet.data, sheet.submitted);
        //onChangeHandler();
    }

    async function getEsfaEyesInfo(year) {
        const url = `{% url "esfa_eyes:api_eyes" year='yearHolder' %}`
            .replace("yearHolder", year)
        try {
            let res = await fetch(url);
            return await res.json();
        }
        catch (err) {
            jSuites.notification({
                error: 1,
                name: 'Error',
                title: "Fetching This month's Sheet",
                message: err,
            });
        }
    }

    async function constructTable(data, readOnlyAll = false) {

    }

    function saveSheet(data) {
        const year = $("#year").val();
        const month = $("#month").val();
        const url = `{% url "sheets:api_sheets" year='yearHolder' month='monthHolder' %}`
            .replace("yearHolder", year)
            .replace("monthHolder", month);
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{csrf_token}}',
            },
            body: JSON.stringify({ "data": data, "saveSheet": true }),
        })
            .then(res => res.json())
            .then(() => updatePaymentsValue())
            .catch(err => {
                jSuites.notification({
                    error: 1,
                    name: 'Error',
                    title: "Updating Sheet",
                    message: err,
                });
            });
    }

    function fillYears(year) {
        for (let i = window.START_YEAR; i <= year; i++) {
            $("#year").append($("<option>").text(i));
        }
    }


    // =================== document ready ============================
    $("document").ready(async function () {
        //var lastPrice = await dollar-tomans-api.fetchAll();
        console.log("document ready!");
        
        const today = new JDate();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        fillYears(currentYear);
        $("#year").val(currentYear);

        initTable();
        $("#year, #month").change(function () {
            initTable();
        });
    });

</script>
{% endblock body %}