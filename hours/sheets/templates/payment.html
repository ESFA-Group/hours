{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'sheets/css/bootstrap-table.min.css' %}">
<style>
    th, td{
        border: 2px solid black !important;
    }
</style>
{% endblock extra_css %}

{% block body %}
<div class="container-fluid">
    <div class="row mt-2">
        <div class="col col-6 col-md-4 col-lg-3">
            <strong>Year</strong>
            <div class="mt-1">
                <select name="year" id="year" style="min-width: 180px; border-radius: 5px; height: 35px;"></select>
            </div>
        </div>
        <div class="col col-6 col-md-4 col-lg-3">
            <strong>Month</strong>
            <div class="mt-1">
                <select name="month" id="month" style="min-width: 180px; border-radius: 5px; height: 35px;">
                    <option value="1">Farvardin</option>
                    <option value="2">Ordibehest</option>
                    <option value="3">Khordad</option>
                    <option value="4">Tir</option>
                    <option value="5">Mordad</option>
                    <option value="6">Shahrivar</option>
                    <option value="7">Mehr</option>
                    <option value="8">Aban</option>
                    <option value="9">Azar</option>
                    <option value="10">Dey</option>
                    <option value="11">Bahman</option>
                    <option value="12">Esfand</option>
                </select>
            </div>
        </div>
    </div>
    <hr>
    <div class="row">
        <div class="col col-6 col-md-4 col-lg-3">
            <strong>Payment Method</strong>
            <div class="mt-1">
                <select name="paymentMethod" id="paymentMethod" style="min-width: 180px; border-radius: 5px; height: 35px;">
                    <option value="AN">Account number</option>
                    <option value="SN">SHEBA number</option>
                </select>
            </div>
        </div>
        <div class="col col-6 col-md-4 col-lg-3">
            <strong>Payment Type</strong>
            <div class="mt-1">
                <select name="paymentType" id="paymentType" style="min-width: 180px; border-radius: 5px; height: 35px;">
                    <option value="base">Base payment</option>
                    <option value="complementary">Complementary payment</option>
                </select>
            </div>
        </div>
        <div class="col col-6 col-md-4 col-lg-3">
            <button id="export" class="btn btn-primary" style="width: 120px; position: relative; top: 27px;">Export</button>
        </div>
    </div>
    <br>
    <table 
    id="payment-table"
    class="table table-sm table-hover"
    data-click-to-select="true" 
    style="table-layout: fixed; text-align: center; min-width: 1000px;">
        <thead class="table-dark">
            <tr>
                <th scope="col" data-field="state" data-checkbox="true" data-width="3" data-width-unit="%">#</th>
                <th scope="col" data-field="userID" class="d-none">ID</th>
                <th scope="col" data-field="user" data-sortable="true" data-width="15" data-width-unit="%">User</th>
                <th scope="col" data-field="totalPayment" data-sortable="true" data-width="12" data-width-unit="%">Total</th>
                <th scope="col" data-field="basePayment" data-width="13" data-width-unit="%">Base Payment</th>
                <th scope="col" data-field="reduction1" data-width="11" data-width-unit="%">Reduction1</th>
                <th scope="col" data-field="reduction2" data-width="11" data-width-unit="%">Reduction2</th>
                <th scope="col" data-field="reduction3" data-width="11" data-width-unit="%">Reduction3</th>
                <th scope="col" data-field="addition" data-width="11" data-width-unit="%">Addition</th>
                <th scope="col" data-field="finalPayment" data-width="13" data-width-unit="%">Final Payment</th>
            </tr>
        </thead>
    </table>
</div>
<br>
<br>
<script src="{% static 'sheets/js/bootstrap-table.min.js' %}"></script>
<script>

    async function getTableData(year, month){
        const url = `{% url "sheets:api_payment" year='yearHolder' month='monthHolder' %}`
            .replace("yearHolder", year)
            .replace("monthHolder", month);
        try{
            let res = await fetch(url);
            return await res.json();
        }
        catch(err){
            jSuites.notification({
                error: 1,
                name: 'Error',
                title: "Fetching Data",
                message: err,
                timeout: 6000,
            });
        }
    }

    async function fillTable(year, month){
        $('#payment-table').bootstrapTable('removeAll');
        const data = await getTableData(year, month);
        for(row of data){
            $('#payment-table').bootstrapTable('insertRow', {
                index: $('#payment-table').bootstrapTable('getOptions').totalRows,
                row: row,
            });
        }
    }

    function fillYears(year){
        for(let i=window.START_YEAR; i<=year; i++){
            $("#year").append($("<option>").text(i));
        }
    }

    $("document").ready(async function(){

        const today = new JDate();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        fillYears(currentYear); 
        $("#year").val(currentYear);
        $("#month").val(currentMonth);

        $("#payment-table").bootstrapTable();

        fillTable(currentYear, currentMonth);

        $("#year, #month").change(function(){
            const year = $("#year").val();
            const month = $("#month").val();
            fillTable(year, month);
        });

        $("#export").click(function(){
            const userIDs = $("#payment-table").bootstrapTable("getSelections").map(row => row.userID);
            const $form = $("<form>", {action: "{% url 'sheets:payment_export' %}", method: "POST"});
            $form.append($("<input type='hidden' name='IDs'>").val(JSON.stringify(userIDs)));
            $form.append($("<input type='hidden' name='month'>").val($("#month").val()));
            $form.append($("<input type='hidden' name='year'>").val($("#year").val()));
            $form.append($("<input type='hidden' name='paymentMethod'>").val($("#paymentMethod").val()));
            $form.append($("<input type='hidden' name='paymentType'>").val($("#paymentType").val()));
            $form.append($("<input type='hidden' name='csrfmiddlewaretoken'>").val("{{csrf_token}}"));
            $("body").append($form);
            $form.submit();
        });

    });
</script>
{% endblock body %}