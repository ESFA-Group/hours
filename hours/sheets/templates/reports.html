{% extends "base.html" %}
{% load static %}

{% block body %}

<div class="container-fluid">
    <div class="row">
        <div class="col col-6 col-md-4 col-lg-3">
            <strong>Year</strong>
            <div class="mt-1">
                <select name="year" id="year" style="min-width: 150px; border-radius: 5px; height: 35px;"></select>
            </div>
        </div>
        <div class="col col-6 col-md-4 col-lg-3">
            <strong>Month</strong>
            <div class="mt-1">
                <select name="month" id="month" style="min-width: 150px; border-radius: 5px; height: 35px;">
                    <option value="1">Farvardin</option>
                    <option value="2">Ordibehest</option>
                    <option value="3">Khordad</option>
                    <option value="4">Tir</option>
                    <option value="5">Mordad</option>
                    <option value="6">Shahrivar</option>
                    <option value="7">Mehr</option>
                    <option value="8">Aban</option>
                    <option value="9">Azar</option>
                    <option value="10">Dey</option>
                    <option value="11">Bahman</option>
                    <option value="12">Esfand</option>
                </select>
            </div>
        </div>
    </div>

    <hr>

    <div class="table-responsive">
        <table id="monthly-table" class="table table-striped table-hover">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>

    async function getMonthlyData(year, month){
        const url = `{% url "sheets:api_monthly_report" year='yearHolder' month='monthHolder' %}`
            .replace("yearHolder", year)
            .replace("monthHolder", month);
        try{
            let res = await fetch(url);
            return await res.json();
        }
        catch (err){
            jSuites.notification({
                error: 1,
                name: 'Error',
                title: "Fetching Report Info",
                message: err,
                timeout: 6000,
            });
        }
    }

    function formatHour(num){
        return `${Math.floor(num / 60)}:${Math.round(num % 60)}`
    }

    async function showReport(year, month){
        const data = await getMonthlyData(year, month);
        $("#monthly-table tbody tr").remove();
        $("#monthly-table thead tr").remove();
        const ths = Object.keys(Object.values(data)[0]);
        const table = $("#monthly-table");
        let tr = $("<tr>");
        ["Name", ...ths].forEach((val, idx) => {
            tr.append($("<th>").text(val));
        });
        table.find("thead").append(tr);
        for(let [key, val] of Object.entries(data)){
            tr = $("<tr>");
            $(tr).append($("<th>").text(key));
            ths.forEach((prj, idx) => {
                $(tr).append($("<td>").text(formatHour(data[key][prj])));
            });
            table.find("tbody").append(tr);
        }
    }

    function fillYears(year){
        for(let i=window.START_YEAR; i<=year; i++){
            $("#year").append($("<option>").text(i));
        }
    }

    $("document").ready(async function() {

        const today = new JDate();
        const currentYear = today.getFullYear();
        const currentMonth = today.getMonth();
        fillYears(currentYear); 
        $("#year").val(currentYear);
        $("#month").val(currentMonth);

        showReport(currentYear, currentMonth);

        $("#year, #month").change(function(){
            const year = $("#year").val();
            const month = $("#month").val();
            showReport(year, month);
        });

    });


</script>
{% endblock body %}